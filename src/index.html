<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3Graph</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="phone_box"></div>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    const container = document.querySelector('.phone_box');
    const width = container.clientWidth;
    const height = container.scrollHeight;

    const markerBoxWidth = 10;
    const markerBoxHeight = 10;
    const refX = markerBoxWidth / 2;
    const refY = markerBoxHeight / 2;
    const markerWidth = markerBoxWidth / 2;
    const markerHeight = markerBoxHeight / 2;
    const arrowPoints = [[0, 0], [10, 5], [0, 10]];

    const color = {
      'person': '#d0edf7',
      'call': '#b0ddc7',
      'main': 'rgba(122, 120, 125, .3)',
    };
    const radius = {
      'person': 26,
      'call': 18,
    };

    const svg = d3.select('.phone_box')
      .append('svg')
        .attr('viewBox', [0, 0, width, height])
      .call(d3.zoom()
        .scaleExtent([1, 3])
        .on('zoom', function() {
          svg.attr('transform', d3.event.transform)
      }))
      .append('g');

    svg.append('defs').append('marker')
      .attr('id', 'arrow')
      .attr('viewBox', [0, 0, markerBoxWidth, markerBoxHeight])
      .attr('refX', refX)
      .attr('refY', refY)
      .attr('markerWidth', markerWidth)
      .attr('markerHeight', markerHeight)
      .attr('orient', 'auto-start-reverse')
      .append('path')
        .attr('d', d3.line()(arrowPoints))
        .attr('stroke', color.main)
        .attr('fill', color.main);

    d3.json('./summertime_calls.json')
      .then(build);

    function build(data) {
      generate(data);

      const simulation = d3.forceSimulation()
        .force('charge', d3.forceManyBody().strength(-150).distanceMin(30).distanceMax(120))
        .force('link', d3.forceLink().id(d => d.id).distance(100))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(radius.person).strength(0.3))
        .on('tick', ticked);

      simulation.nodes(data.nodes);
      simulation.force('link').links(data.relationships);

      function generate(data) {
        const cNodes = d3.max(data.nodes.filter(node => node.duration));
        const cScale = d3.scaleLinear()
          .domain([0, cNodes.duration])
          .range(['#fff', color.call]);


        const link = svg.selectAll('.link')
          .data(data.relationships)
          .enter().append('line')
            .attr('class', 'link')
            .attr('stroke', color.main)
            .attr('marker-end', 'url(#arrow)');


        const node = svg.selectAll('.node')
          .data(data.nodes)
          .join('g')
            .attr('class', 'node')
          .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended)
          );
  
        node.append('circle')
          .attr('r', d => d.type === 'person' ? radius.person : radius.call)
          .attr('stroke', color.main)
          .style('fill', d => d.type === 'person' ? color.person : cScale(d.duration));
  
        node.filter(d => d.name)
          .append('text')
            .text(d => d.name)
            .attr('class', 'title')
            .attr('text-anchor', 'middle')
            .attr('dy', '.35em');
      }
  
      function ticked() {
        d3.selectAll('.link')
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);
  
        d3.selectAll('.node')
          .attr("transform", d => `translate(${+d.x}, ${+d.y})`);
      }
  
  
      function dragstarted(d) {
        simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragended(d) {
        simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    }


  </script>
</body>
</html>
